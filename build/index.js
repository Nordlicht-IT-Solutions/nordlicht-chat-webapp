!function(e,t){if("object"===typeof exports&&"object"===typeof module)module.exports=t(require("react"),require("react-dom"));else if("function"===typeof define&&define.amd)define(["react","react-dom"],t);else{var a="object"===typeof exports?t(require("react"),require("react-dom")):t(e.react,e["react-dom"]);for(var n in a)("object"===typeof exports?exports:e)[n]=a[n]}}(this,(function(e,t){return function(e){function t(t){for(var n,l,c=t[0],i=t[1],s=t[2],m=0,d=[];m<c.length;m++)l=c[m],Object.prototype.hasOwnProperty.call(o,l)&&o[l]&&d.push(o[l][0]),o[l]=0;for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n]);for(u&&u(t);d.length;)d.shift()();return r.push.apply(r,s||[]),a()}function a(){for(var e,t=0;t<r.length;t++){for(var a=r[t],n=!0,c=1;c<a.length;c++){var i=a[c];0!==o[i]&&(n=!1)}n&&(r.splice(t--,1),e=l(l.s=a[0]))}return e}var n={},o={0:0},r=[];function l(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,l),a.l=!0,a.exports}l.m=e,l.c=n,l.d=function(e,t,a){l.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},l.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.t=function(e,t){if(1&t&&(e=l(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(l.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)l.d(a,n,function(t){return e[t]}.bind(null,n));return a},l.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return l.d(t,"a",t),t},l.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},l.p="/";var c=this["webpackJsonpmy-lib"]=this["webpackJsonpmy-lib"]||[],i=c.push.bind(c);c.push=t,c=c.slice();for(var s=0;s<c.length;s++)t(c[s]);var u=i;return r.push([88,1]),a()}({0:function(t,a){t.exports=e},11:function(e,a){e.exports=t},88:function(e,t,a){e.exports=a(94)},94:function(e,t,a){"use strict";a.r(t),a.d(t,"App",(function(){return je}));var n=a(68),o=a(12),r=(a(89),a(0)),l=a.n(r),c=a(53),i=a(54),s=a(145),u=a(13),m=a(133),d=a(137),p=a(138),f=a(142),b=a(97),E=a(154),v=a(141),g=a(143),h=a(144),y=a(146),O=a(147),j=a(32),C=a(75),k=a(149),w=a(170),S=a(173),R=a(159),x=a(156),D=a(160),L=a(157),N=a(153),T=a(161),W=a(150),M=a(140),I=a(152),P=a(155),F=a(171),A=a(148),J=a(151),z=a(139),B=a(167),q=a(169),U=function(e){var t=e.open,a=e.onClose,n=e.client,c=e.joinedRooms,i=Object(r.useState)(""),s=Object(o.a)(i,2),u=s[0],f=s[1],b=Object(r.useState)([]),E=Object(o.a)(b,2),v=E[0],y=E[1];Object(r.useEffect)((function(){t&&(n.call("getRooms",[]).then((function(e){var t=new Set(c);y(e.filter((function(e){return!t.has(e)&&!e.startsWith("!")})).sort())})),f(""))}),[n,t,c]);var O=Object(r.useCallback)((function(){a()}),[a]),j=Object(r.useCallback)((function(e){e.preventDefault(),a(u||void 0)}),[a,u]);return l.a.createElement(m.a,{open:t,onClose:O},l.a.createElement("form",{onSubmit:j},l.a.createElement(d.a,null,"Which room to join?"),l.a.createElement(p.a,null,l.a.createElement(z.a,null,"Select existing or create new room."),l.a.createElement(q.a,{freeSolo:!0,autoSelect:!0,options:v,renderInput:function(e){return l.a.createElement(B.a,Object.assign({},e,{label:"Room",variant:"outlined",margin:"dense",fullWidth:!0}))},onChange:function(e,t){t&&f(t)},multiple:!1})),l.a.createElement(g.a,null,l.a.createElement(h.a,{type:"button",autoFocus:!0,onClick:O,color:"primary"},"Cancel"),l.a.createElement(h.a,{type:"submit",color:"primary",autoFocus:!0},"Join"))))},_=function(e){var t=e.open,a=e.onClose,n=e.client,c=e.knownUsers,i=Object(r.useState)(""),s=Object(o.a)(i,2),u=s[0],f=s[1],b=Object(r.useState)([]),E=Object(o.a)(b,2),v=E[0],y=E[1];Object(r.useEffect)((function(){t&&(n.call("getUsers",[]).then((function(e){var t=new Set(c);y(e.filter((function(e){return!t.has(e)})).sort())})),f(""))}),[n,t,c]);var O=Object(r.useCallback)((function(){a()}),[a]),j=Object(r.useCallback)((function(e){e.preventDefault(),a(u||void 0)}),[a,u]);return l.a.createElement(m.a,{open:t,onClose:O},l.a.createElement("form",{onSubmit:j},l.a.createElement(d.a,null,"Which user to contact?"),l.a.createElement(p.a,null,l.a.createElement(z.a,null,"Find user to contact."),l.a.createElement(q.a,{options:v,renderInput:function(e){return l.a.createElement(B.a,Object.assign({},e,{label:"Contact name",variant:"outlined",margin:"dense",fullWidth:!0}))},onChange:function(e,t){t&&f(t)},multiple:!1})),l.a.createElement(g.a,null,l.a.createElement(h.a,{type:"button",autoFocus:!0,onClick:O,color:"primary"},"Cancel"),l.a.createElement(h.a,{type:"submit",color:"primary",autoFocus:!0,disabled:!u},"Add contact"))))},H=Object(s.a)((function(e){return{subheaderWithButton:{display:"flex",justifyContent:"space-between"}}})),V=function(e){var t=e.activeRoom,a=e.rooms,n=e.onRoomSelect,i=e.user,s=e.onLogOut,u=e.client,m=Object(r.useCallback)((function(e){n(e.currentTarget.dataset.id)}),[n]),d=l.a.useState(null),p=Object(o.a)(d,2),g=p[0],j=p[1],w=Boolean(g),S=Object(r.useCallback)((function(e){j(e.currentTarget)}),[]),R=Object(r.useCallback)((function(){j(null)}),[]),D=Object(r.useCallback)((function(){j(null),s()}),[s]),T=Object(r.useState)(!1),F=Object(o.a)(T,2),z=F[0],B=F[1],q=Object(r.useCallback)((function(){j(null),B(!0)}),[]),V=Object(r.useCallback)((function(e){B(!1),e&&u.call("joinRoom",[e]).then((function(t){console.info("JOIN ROOM",t),n(e)})).catch((function(e){console.error("JOIN ROOM",e)})).then((function(){j(null)}))}),[u,n]),Y=Object(r.useState)(!1),K=Object(o.a)(Y,2),Q=K[0],X=K[1],Z=Object(r.useCallback)((function(){j(null),X(!0)}),[]),$=Object(r.useCallback)((function(e){if(X(!1),e){var t="!".concat([e,i].sort().join("!"));u.call("joinRoom",[t]).then((function(e){console.info("ADD CONTACT",e),n(t)})).catch((function(e){console.error("ADD CONTACT",e)})).then((function(){j(null)}))}}),[u,n,i]),ee=H();return l.a.createElement("div",null,l.a.createElement(U,{client:u,open:z,onClose:V,joinedRooms:Object.keys(a)}),l.a.createElement(_,{client:u,open:Q,onClose:$,knownUsers:[i].concat(Object(c.a)(Object.keys(a).filter((function(e){return e.startsWith("!")})).map((function(e){return e.replace("!".concat(i),"").slice(1)}))))}),l.a.createElement(y.a,{position:"static"},l.a.createElement(O.a,null,l.a.createElement(h.a,{startIcon:l.a.createElement(A.a,null),"aria-label":"account of current user","aria-controls":"menu-appbar","aria-haspopup":"true",onClick:S,color:"inherit"},i),l.a.createElement(C.a,{id:"menu-appbar",anchorEl:g,anchorOrigin:{vertical:"top",horizontal:"right"},keepMounted:!0,transformOrigin:{vertical:"top",horizontal:"right"},open:w,onClose:R},l.a.createElement(k.a,{onClick:D},"Log out")))),l.a.createElement(W.a,null),l.a.createElement(f.a,{dense:!0,subheader:l.a.createElement(M.a,{className:ee.subheaderWithButton},l.a.createElement("div",null,"Joined rooms"),l.a.createElement(v.a,{onClick:q,edge:"end"},l.a.createElement(J.a,null)))},Object.keys(a).filter((function(e){return!e.startsWith("!")})).sort().map((function(e){return l.a.createElement(b.a,{key:e,button:!0,"data-id":e,onClick:m,selected:e===t},l.a.createElement(I.a,null,l.a.createElement(N.a,null)),l.a.createElement(E.a,null,e),l.a.createElement(P.a,null,G(a,e)))}))),l.a.createElement(W.a,null),l.a.createElement(f.a,{dense:!0,subheader:l.a.createElement(M.a,{className:ee.subheaderWithButton},l.a.createElement("div",null,"Contacts"),l.a.createElement(v.a,{onClick:Z,edge:"end"},l.a.createElement(x.a,null)))},Object.keys(a).filter((function(e){return e.startsWith("!")})).sort().map((function(e){return l.a.createElement(b.a,{key:e,button:!0,"data-id":e,onClick:m,selected:e===t},l.a.createElement(I.a,null,l.a.createElement(L.a,null)),l.a.createElement(E.a,null,e.replace("!".concat(i),"").slice(1)),l.a.createElement(P.a,null,G(a,e)))}))))};function G(e,t){var a=e[t].events.filter((function(a){return a.ts>e[t].lastRead})).length;return a?l.a.createElement(F.a,{label:a,size:"small",color:"primary"}):null}var Y=a(172),K=a(158),Q=a(168),X=function(e){var t=e.client,a=e.selectedRoom,n=Object(r.useState)(""),c=Object(o.a)(n,2),i=c[0],s=c[1],u=Object(r.useCallback)((function(e){s(e.target.value)}),[]),m=Object(r.useCallback)((function(e){e.preventDefault(),i&&a&&(t.call("sendMessage",{room:a,message:i}),s(""))}),[i,a,t]);return l.a.createElement("form",{noValidate:!0,autoComplete:"off",onSubmit:m},l.a.createElement(B.a,{fullWidth:!0,label:"Message",variant:"outlined",value:i,onChange:u,size:"small",autoFocus:!0}))},Z=Object(s.a)((function(e){return Object(Y.a)({toolbar:e.mixins.toolbar,content:{flexGrow:1,display:"flex",flexDirection:"column"},messages:{flex:"1 1 auto",overflowY:"auto",minHeight:0,display:"flex",flexDirection:"column"}})})),$=new Intl.DateTimeFormat("default",{hour:"numeric",minute:"numeric",second:"numeric"}),ee=new Intl.DateTimeFormat("default",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}),te=function(e){var t=e.roomEvent,a=new Date,n=new Date(t.ts),o=a.getDate()===n.getDate()&&a.getMonth()===n.getMonth()&&a.getFullYear()===n.getFullYear();return l.a.createElement(j.a,{variant:"caption",color:"textSecondary",display:"inline"},l.a.createElement("small",null,(o?$:ee).format(t.ts)))},ae=function(e){var t=e.client,a=e.roomEvents,n=e.selectedRoom,o=Object(r.useRef)(null);Object(r.useLayoutEffect)((function(){o.current&&(o.current.scrollTop=o.current.scrollHeight)}),[a]);var c=Z(),i=Object(r.useMemo)((function(){return(null!==a&&void 0!==a?a:[]).map((function(e){return l.a.createElement(r.Fragment,{key:e.id},"join"===e.type?l.a.createElement(K.a,{item:!0},l.a.createElement(j.a,{color:"textSecondary",variant:"body2",display:"inline"},l.a.createElement("b",null,e.sender)," joined"," "),l.a.createElement(te,{roomEvent:e})):"leave"===e.type?l.a.createElement(K.a,{item:!0},l.a.createElement(j.a,{color:"textSecondary",variant:"body2",display:"inline"},l.a.createElement("b",null,e.sender)," left"," ",l.a.createElement(te,{roomEvent:e}))):"message"===e.type?l.a.createElement(K.a,{item:!0,container:!0,direction:"column"},l.a.createElement(K.a,{item:!0},l.a.createElement(j.a,{variant:"subtitle2",color:"textPrimary",display:"inline"},e.sender)," ",l.a.createElement(te,{roomEvent:e})),l.a.createElement(K.a,{item:!0},e.message)):l.a.createElement(K.a,{item:!0},JSON.stringify(e)," "))}))}),[a]);return l.a.createElement("main",{className:c.content},l.a.createElement("div",{className:c.toolbar}),l.a.createElement("div",{className:c.messages,ref:o},l.a.createElement(Q.a,{marginTop:"auto",marginBottom:1,p:1},l.a.createElement(K.a,{item:!0,container:!0,direction:"column",spacing:1},i))),l.a.createElement(Q.a,{p:1,paddingTop:0},l.a.createElement(X,{client:t,selectedRoom:n})))},ne=Object(s.a)((function(e){return{"@global":{},root:{display:"flex",flexGrow:1,height:"100%"},drawer:Object(i.a)({},e.breakpoints.up("sm"),{width:240,flexShrink:0}),appBar:Object(i.a)({},e.breakpoints.up("sm"),{width:"calc(100% - ".concat(240,"px)"),marginLeft:240}),menuButton:Object(i.a)({marginRight:e.spacing(2)},e.breakpoints.up("sm"),{display:"none"}),drawerPaper:{width:240,position:"absolute"},title:{flexGrow:1}}})),oe=function(e){var t,a,n,i,s,W,M=e.client,I=e.onLogOut,P=e.rooms,F=e.user,A=e.selectedRoom,J=e.onRoomSelect,z=Object(r.useRef)(null),B=A&&null!==(t=null===(a=P[A])||void 0===a?void 0:a.events)&&void 0!==t?t:void 0;Object(r.useLayoutEffect)((function(){z.current&&(z.current.scrollTop=z.current.scrollHeight)}),[B]),Object(r.useEffect)((function(){A&&!P[A]&&J(void 0)}),[J,A,P]);var q=ne(),U=Object(u.a)(),_=Object(r.useState)(!1),H=Object(o.a)(_,2),G=H[0],Y=H[1],K=Object(r.useCallback)((function(){Y(!1)}),[]),Q=Object(r.useCallback)((function(){Y(!0)}),[]),X=Object(r.useCallback)((function(e){Y(!1),J(e)}),[J]),Z=l.a.useState(null),$=Object(o.a)(Z,2),ee=$[0],te=$[1],oe=Boolean(ee),re=Object(r.useCallback)((function(e){te(e.currentTarget)}),[]),le=Object(r.useCallback)((function(){te(null),M.call("leaveRoom",[A]).then((function(e){console.log("LEAVE ROOM",e)})).catch((function(e){console.log("LEAVE ROOM",e)}))}),[M,A]),ce=Object(r.useCallback)((function(){te(null)}),[]),ie=Object(r.useState)(!1),se=Object(o.a)(ie,2),ue=se[0],me=se[1],de=Object(r.useCallback)((function(){te(null),me(!0)}),[]),pe=Object(r.useCallback)((function(){me(!1)}),[]),fe=l.a.createElement(V,{activeRoom:A,rooms:P,onRoomSelect:X,user:F,onLogOut:I,client:M}),be=Object(r.useCallback)((function(e){var t="!".concat([e,F].sort().join("!"));M.call("joinRoom",[t]).then((function(e){console.info("ADD CONTACT",e),J(t)})).catch((function(e){console.error("ADD CONTACT",e)})).then((function(){me(!1)}))}),[M,J,F]);return l.a.createElement("div",{className:q.root},l.a.createElement(m.a,{open:ue,onClose:pe},l.a.createElement(d.a,null,"Room members"),l.a.createElement(p.a,null,A&&l.a.createElement(f.a,{dense:!0},Object(c.a)(null!==(n=null===(i=P[A])||void 0===i?void 0:i.users)&&void 0!==n?n:[]).sort().map((function(e){return l.a.createElement(b.a,{key:e},l.a.createElement(E.a,null,e),e===F?null:Object.keys(P).some((function(t){return"!"===t[0]&&t.split("!").includes(e)}))?l.a.createElement(v.a,{edge:"end",onClick:function(){me(!1),J("!".concat([e,F].join("!")))}},l.a.createElement(R.a,null)):l.a.createElement(v.a,{edge:"end",onClick:function(){return be(e)}},l.a.createElement(x.a,null)))})))),l.a.createElement(g.a,null,l.a.createElement(h.a,{type:"button",autoFocus:!0,onClick:pe,color:"primary"},"Close"))," "),l.a.createElement(y.a,{position:"absolute",className:q.appBar},l.a.createElement(O.a,null,l.a.createElement(v.a,{edge:"start",className:q.menuButton,color:"inherit","aria-label":"open drawer",onClick:Q},l.a.createElement(D.a,null)),l.a.createElement(j.a,{variant:"h6",className:q.title},A?l.a.createElement(l.a.Fragment,null,A.startsWith("!")?l.a.createElement(L.a,{fontSize:"inherit"}):l.a.createElement(N.a,{fontSize:"inherit"})," ",A.startsWith("!")?A.replace("!".concat(F),"").slice(1):A):l.a.createElement("i",null,"No chat active")),A&&l.a.createElement(l.a.Fragment,null,l.a.createElement(v.a,{"aria-label":"account of current user","aria-controls":"menu-appbar","aria-haspopup":"true",onClick:re,color:"inherit"},l.a.createElement(T.a,null)),l.a.createElement(C.a,{id:"menu-appbar",anchorEl:ee,anchorOrigin:{vertical:"top",horizontal:"right"},keepMounted:!0,transformOrigin:{vertical:"top",horizontal:"right"},open:oe,onClose:ce},l.a.createElement(k.a,{onClick:le},A.startsWith("!")?"Forget contact":"Leave room"),!A.startsWith("!")&&l.a.createElement(k.a,{onClick:de},"Show room members"))))),l.a.createElement("nav",{className:q.drawer,"aria-label":"mailbox folders"},l.a.createElement(w.a,{smUp:!0,implementation:"css"},l.a.createElement(S.a,{variant:"temporary",anchor:"rtl"===U.direction?"right":"left",open:G,onClose:K,classes:{paper:q.drawerPaper},ModalProps:{keepMounted:!0}},fe)),l.a.createElement(w.a,{xsDown:!0,implementation:"css"},l.a.createElement(S.a,{classes:{paper:q.drawerPaper},variant:"permanent",open:!0},fe))),A&&l.a.createElement(ae,{client:M,roomEvents:null!==(s=null===(W=P[A])||void 0===W?void 0:W.events)&&void 0!==s?s:[],selectedRoom:A}))},re=a(162),le=a(174),ce=a(164),ie=a(163),se=Object(s.a)((function(e){return{paper:{marginTop:e.spacing(8),display:"flex",flexDirection:"column",alignItems:"center"},avatar:{margin:e.spacing(1),backgroundColor:e.palette.secondary.main},form:{width:"100%",marginTop:e.spacing(1)},submit:{margin:e.spacing(3,0,2)}}})),ue=function(e){var t=e.onLogin,a=se(),n=Object(r.useState)(""),c=Object(o.a)(n,2),i=c[0],s=c[1],u=Object(r.useState)(""),m=Object(o.a)(u,2),d=m[0],p=m[1],f=Object(r.useCallback)((function(e){e.preventDefault(),t(i,d)}),[t,i,d]),b=Object(r.useCallback)((function(e){s(e.target.value)}),[s]),E=Object(r.useCallback)((function(e){p(e.target.value)}),[p]);return l.a.createElement(re.a,{component:"main",maxWidth:"xs"},l.a.createElement("div",{className:a.paper},l.a.createElement(le.a,{className:a.avatar},l.a.createElement(ie.a,null)),l.a.createElement(j.a,{component:"h1",variant:"h5"},"Sign in"),l.a.createElement("form",{className:a.form,noValidate:!0,onSubmit:f},l.a.createElement(B.a,{variant:"outlined",margin:"normal",required:!0,fullWidth:!0,label:"Username",name:"username",autoComplete:"username",autoFocus:!0,value:i,onChange:b}),l.a.createElement(B.a,{variant:"outlined",margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:"password",autoComplete:"current-password",value:d,onChange:E}),l.a.createElement(h.a,{type:"submit",fullWidth:!0,variant:"contained",color:"primary",className:a.submit},"Sign In"),l.a.createElement(K.a,{container:!0},l.a.createElement(K.a,{item:!0,xs:!0},l.a.createElement(ce.a,{href:"#",variant:"body2"},"Forgot password?")),l.a.createElement(K.a,{item:!0},l.a.createElement(ce.a,{href:"#",variant:"body2"},"Don't have an account? Sign Up"))))))},me=a(55),de=a(74),pe=a(165),fe=a(166),be=a(96),Ee=a(76),ve=a(60);Object(ve.a)();var ge={loginInProgress:!1,client:void 0,authData:void 0,rooms:{},connectionState:"closed",connectionReason:void 0,selectedRoom:void 0};function he(e,t){return Object(ve.b)(e,(function(e){switch(t.type){case"init":Object.assign(e,ge);break;case"startLogin":e.loginInProgress=!0;break;case"stopLogin":e.loginInProgress=!1;break;case"setClient":e.client=t.payload;break;case"setAuthData":e.authData=t.payload;break;case"addRoomEvent":e.rooms[t.payload.room].events.push(t.payload);break;case"userJoined":var a=e.rooms[t.payload.room];a||(a={users:new Set,lastRead:0,events:[]},e.rooms[t.payload.room]=a),a.users.add(t.payload.user),a.lastRead=t.payload.lastRead;break;case"userLeft":if(t.payload.user===e.authData)return void delete e.rooms[t.payload.room];var n=e.rooms[t.payload.room];n&&n.users.delete(t.payload.user);break;case"setConnectionState":e.connectionState=t.payload.state,e.connectionReason=t.payload.code;break;case"setLastRead":e.rooms[t.payload.room].lastRead=t.payload.lastRead;break;case"selectRoom":e.selectedRoom=t.payload;break;default:throw Error("unknown action")}}))}var ye=Object(de.a)({palette:{primary:me.a}}),Oe=Object(s.a)((function(e){return Object(Y.a)({backdrop:{zIndex:e.zIndex.drawer+1,color:"#fff"}})})),je=function(){var e=Object(r.useReducer)(he,ge),t=Object(o.a)(e,2),a=t[0],c=t[1];Object(r.useEffect)((function(){if(void 0===a.client){c({type:"setConnectionState",payload:{state:"connecting"}});var e,t=new WebSocket("".concat(window.location.protocol.replace("http","ws"),"//").concat("3000"===window.location.port||"6060"===window.location.port?"localhost:8080":window.location.host,"/chat")),o=new Map,r=1;return t.addEventListener("open",(function(){console.info("WS Open"),c({type:"setConnectionState",payload:{state:"connected"}});var e=window.localStorage.getItem("user");e&&(c({type:"startLogin"}),l("login",[e]).then((function(){c({type:"setAuthData",payload:e})})).finally((function(){c({type:"stopLogin"})})))})),t.addEventListener("message",(function(e){var t=JSON.parse(e.data),a=t.id,n=t.result,r=t.error,l=t.method,i=t.params;if("2.0"===t.jsonrpc)if(l&&i)console.log("METHOD",l,i),"joinRoom"===l?c({type:"userJoined",payload:i}):"leaveRoom"===l?c({type:"userLeft",payload:i}):"roomEvent"===l?c({type:"addRoomEvent",payload:i}):"lastRead"===l&&c({type:"setLastRead",payload:i});else if(void 0!==a&&(r||void 0!==n)){var s=o.get(a);s&&(o.delete(a),r?s.reject(r):s.resolve(n))}})),t.addEventListener("error",(function(e){console.error("WS Error",e)})),t.addEventListener("close",(function(t){console.info("WS Close",t);var a,r=Object(n.a)(o.values());try{for(r.s();!(a=r.n()).done;){a.value.reject(new Error("connection closed"))}}catch(l){r.e(l)}finally{r.f()}c({type:"setConnectionState",payload:{state:"closed",code:t.code}}),1e3!==t.code&&1005!==t.code&&(e=window.setTimeout((function(){e=void 0,c({type:"init"})}),1e3))})),c({type:"setClient",payload:{ws:t,call:l}}),function(){window.clearTimeout(e)}}function l(e,a){return new Promise((function(n,l){t.send(JSON.stringify({jsonrpc:"2.0",id:r,method:e,params:a})),o.set(r,{resolve:n,reject:l}),r++}))}}),[a.client]),Object(r.useEffect)((function(){if(a.client&&a.selectedRoom){var e=a.rooms[a.selectedRoom];if(e&&e.events.length){var t=e.events[e.events.length-1].ts;t!==e.lastRead&&a.client.call("setRoomLastRead",{room:a.selectedRoom,lastRead:t})}}}),[a.client,a.selectedRoom,a.rooms]);var i=Object(r.useCallback)((function(e,t){if(!a.client)throw new Error("no client");c({type:"startLogin"}),a.client.call("login",[e]).then((function(){window.localStorage.setItem("user",e),c({type:"setAuthData",payload:e})})).finally((function(){c({type:"stopLogin"})}))}),[a.client]),s=Object(r.useCallback)((function(){var e=a.client;e&&e.call("logout",[]).then((function(){c({type:"setConnectionState",payload:{state:"closing"}}),null===e||void 0===e||e.ws.close(),window.localStorage.removeItem("user"),c({type:"init"})}))}),[a.client]),u=["connecting","closing","closed"].includes(a.connectionState),m=u?Ce[a.connectionState]:a.loginInProgress?"Logging in...":a.client?null:"Loading...",d=Oe(),p=Object(r.useCallback)((function(e){c({type:"selectRoom",payload:e})}),[]);return l.a.createElement(pe.a,{theme:ye},l.a.createElement(fe.a,null),l.a.createElement(be.a,{open:!!m,className:d.backdrop},l.a.createElement(Ee.a,{elevation:2},l.a.createElement(Q.a,{padding:2},m))),u||!a.client?null:a.authData?l.a.createElement(oe,{client:a.client,onLogOut:s,rooms:a.rooms,user:a.authData,onRoomSelect:p,selectedRoom:a.selectedRoom}):l.a.createElement(ue,{onLogin:i}))},Ce={closed:"Reconnecting...",connecting:"Reconnecting...",closing:"Closing...",connected:"Connected."}}})}));
//# sourceMappingURL=index.js.map